import boto3
ec2 = boto3.client('ec2')
sns = boto3.client('sns')

def send_notification(message):
    sns.publish(
        TopicArn='arn:aws:sns:your-region:your-account-id:ec2-actions-notification',
        Message=message,
        Subject="AWS EC2 Action Notification"
    )

def lambda_handler(event, context):
    # Get list of all EC2 instances
    instances = ec2.describe_instances(Filters=[{'Name': 'instance-state-name', 'Values': ['running']}])
    
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            instance_id = instance['InstanceId']
            # Check if instance is idle (e.g., no usage for a certain period)
            # Add your idle criteria here (e.g., instance tags, last activity time, etc.)
            
            # Send notification before stopping
            send_notification(f"EC2 instance {instance_id} will be stopped due to inactivity.")
            
            # Stop the instance
            ec2.stop_instances(InstanceIds=[instance_id])
            print(f"Stopped instance: {instance_id}")
